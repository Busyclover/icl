---
title: "Retail Analytics Individual Assignment Report"
author: "Jim Leach"
date: "7 April 2016"
output:
  pdf_document:
    fig_caption: yes
  word_document: default
---

```{r source, echo = FALSE, message = FALSE, warning = FALSE}
# Load packages
library(dplyr)
library(tidyr)
library(magrittr)
library(mlogit)
library(ggplot2)
library(GGally)
library(broom)
library(knitr)

# Set up theme object
theme_jim <-  theme(legend.position = "bottom",
                    axis.text.y = element_text(size = 16, colour = "black"),
                    axis.text.x = element_text(size = 16, colour = "black"),
                    legend.text = element_text(size = 16),
                    legend.title = element_text(size = 16),
                    title = element_text(size = 16),
                    strip.text = element_text(size = 16, colour = "black"),
                    strip.background = element_rect(fill = "white"),
                    panel.grid.minor.x = element_blank(),
                    panel.grid.major.x = element_line(colour = "grey", linetype = "dotted"),
                    panel.grid.minor.y = element_line(colour = "lightgrey", linetype = "dotted"),
                    panel.grid.major.y = element_line(colour = "grey", linetype = "dotted"),
                    panel.margin.y = unit(0.1, units = "in"),
                    panel.background = element_rect(fill = "white", colour = "lightgrey"),
                    panel.border = element_rect(colour = "black", fill = NA))

# source extra functions
source("./r/functions/toproper.R")
source("./r/functions/ggally_cor.R")

# Step 0 - get and clean --------------------------------------------------
source("./r/files/000_clean_and_filter.R")
source("./r/files/001_clean_brands.R")
source("./r/files/002_create_id.R")
source("./r/files/003_light_vs_heavy.R")
source("./r/files/009_coffee_wide.R")
source("./r/files/010_coffee_long.R")

# Step 1 - elasticity modelling ----------------------------------------------
source("./r/files/100_elasticity_models.R")
source("./r/files/101_clout_and_vuln_stats.R")


# Step 2 - switching matrices ---------------------------------------------
source("./r/files/201_cooccurence_matrices.R")
source("./r/files/202_switching_matrices.R")
source("./r/files/203_market_share_correlation.R")


# Step 3 - user type level modelling --------------------------------------
# shop choice
source("./r/files/301_choice_models.R")
# shop traffic
source("./r/files/302_traffic_models.R")

# Step 5 - Prepare further visualisations ---------------------------------

source("./r/files/501_vis_weekly_share_to_prop_promo.R")
source("./r/files/502_vis_clout_and_vuln_map.R")
source("./r/files/503_vis_repeat_purchase_rate.R")
source("./r/files/504_vis_weekly_price_to_share.R")
source("./r/files/505_vis_sales_by_week.R")
source("./r/files/506_vis_share_by_week.R")

```

# Introduction

Using data from _Katar Worldpanel_ covering sales of coffee over a year at several major UK retailers, the task of this assignment was to develop a response to the question: 

> "How do stores compete? If one store sees an improvement in traffic and sales, how was that store able to achieve such improvements in performance? Is it from stealing from other stores, and which competitors are likely the most affected? How would you model this data considering these findings and what suggestion would you give in terms of growing future sales?"

This report presents a response to this question. Whilst the data are confidential, both the intermediate and final analytical code/results are packaged with this report, and can also be found on the online repository here: [https://github.com/Jim89/icl/tree/master/retail/project](https://github.com/Jim89/icl/tree/master/retail/project).

This question has been approached in a number of ways. The following analyses have been considered and performed:

* Weekly market share correlations;
* Switching, and co-occurrence matrices;
* Shop-level price elasticity;
* Shop choice modelling; and
* Shop traffic modelling.

The results of these analyses allow a number of conclusions to be drawn, as well as some recommendations made. It should be noted that (as advised in the project brief) this report has been from the perspective of a shop manager at Morrisons). It should also be noted that as per the assignment instructions, the same data were used as had been for the group project. This meant that only data from the following retailers were included: Tesco, Asda, Sainsburys, Morrisons, Aldi, and Lidl. Additionally, only the following coffee types were retained: granules, freeze-dried and micro-ground.

## Executive summary

TODO

***

# Analysis

### Data preparation

## Approach

In order to prepare the raw data for the analyses various steps were taken:

Minor retailers were filtered out of the sample, and Aldi and Lidl were combined in to a single "Discounters" shop. Brand names were cleaned and grouped. Minor brands were labelled as "Other" and several minor brands falling under a major label were combined (e.g. all of Nescafe's products were labelled as "Nescafe"). This process resulted in the presence of five supermarkets, and six distinct brands (including "other") in the data. 

Transaction and visit IDs were created. The former indicated each individual purchase (i.e. the unique combination of date, customer, shop and brand) wherease the latter indicated a visit (i.e. the unique combination of data, customer and shop). As such it is possible for several transactions to occur within a single visit. 

Users were classified into one of three types: light, medium or heavy. This classification was performed as in the group exercise (Leach et al, 2016) using the average volume of coffee purchased per visit by the user. 

The data were also transformed in to two separate formats: wide and long. The wide format aggregated sales for each shop at a daily level. For each shop, the average price of coffee on each day was calculated, along with the proportion of sales on that day which were made on a price-based promotion, and the proportion made on a unit-based promotion. The long format data aggregated data at a _transaction_ level. For each transaction, the choice of shop (from the possible five choices) made by the consumer was indicated, along with the brand that they purchased and the price of that brand at each of the shops listed. Data on the levels of promotion available at each of the shops was included, along with the loyalty of the customer of the transaction to each of the five shops. Shop loyalties were calculated based on the first 20 weeks worth of data provided. Customers that did not appear in the first 20 weeks of data (and so for who loyalties could not be calculated) were assumed to have the average shop loyalties of other customers in their segment (i.e. light, medium, or heavy).

Data quality and validation results from earlier work (Leach et al, 2016) were also used, and no further quality or validity checks were made of the data. 

### Market Structure

In order to understand the market structure, several visualisations were created. Total and per-shop sales per week were charted, along with weekly market shares for each shop. The relationship between price and market share was plotted for each shop, as was the relationship between promotions and market share. 

The correlations between weekly market shares for all shops was investigated to understand which shops might be stealing customers from others. The correlation between market share and weekly _total sales_ (across the whole market) was also investigated to understand whether, for weeks in which a particular shop's market share changed, whether that change was due to customers shopping elsewhere, or new shoppers/new sales being made in the market. 

Finally, switching matrices (based on visit ID) were created for each customer segment in order to identify which shops might be seeing customers move between them. Using these results, plots were made to show the proportion of repeat purchases out of total purchases for each shop to help assess which shops had more loyal customers. Co-occurence matrices were also made at a weekly level, to identify (for customers with more than one visit in each week) which shops might be competing based on users shopping at both of them in a single week. 

### Price Elasticitiy

Using the _wide_ format data, own and cross-price elasticities were calculated for each shop. Calculating elasticities at an individual-segment level lead to insignificant and/or strange results, and so this was done at an aggregate level, i.e. accross all three customer segments. Clout and vulnerability statistics were also created and visualised. 

### Shop Choice

A simple model was created which modelled the effect of price, promotion and loyalty on a customers choice of shop. In order to account for potential unobserved differences in consumers (e.g. income, family size etc) this model was applied to each customer segment separately. 

The model is limited, however, as important data such as the total spend on each trip and demographic information were not available. Moreover, there is no data for trips to the shop when coffee was _not_ purchased. As such, this choice model is inherently conditional on a purchase of coffee taking place.  

There is also an implicit assumption that all consumers actually have physical access to each shop and have knowledge of the average price and promotional level at each of the alternative shop choices (which may not have been the case in reality).


### Shop Traffic

Shop _traffic_ in the form of visits per day was also modelled as an alternative to shop choice. As with shop choice, this model is specific to coffee sales only. It relates traffic at a shop to the brand purchased, the average price and promotional level for the shop/brand combination on that day, as well as including the minimum and maximum price (accross all shops) for that brand on that day to model reference-price effects. 

It should be noted that the traffic model was _not_ made conditional on a purchase, i.e. for days when no purchases were observed in the category it was assumed that no visits occurred on that day.

## Results

### Market Structure

Firstly, a plot of total and per-shop weekly transactions (figure TODO) shows that, broadly, the total market is relatively flat (the yellow line and smoother in the plot), as are the sales of the individual shops.

```{r show_sales_by_week, echo = FALSE, message = FALSE, warning = FALSE, fig.height = 5, fig.width = 9, fig.cap = "Total (in yellow, with smoother) and shop-level sales per week. Note the peaks in Morrisons' sales just prior to weeks 20 and 40."}
sales_by_week
```

It is the case that Morrisons has two "spikes" in its weekly transactions, around weeks twenty and fourty. Both of these peaks correspond with increased total market transactions, and none of the other shops show spikes in transactions at this time. 

Plotting each shop's market share for each week (figure TODO) shows a similar pattern. The market share of Morrisons (along with the other shops) is relatively constant at around twenty to twenty-five percent. Two peaks are observed in the Morrisons market share around weeks twenty and fourty. In these weeks it appears that it is a combination of Tesco and Sainsburys that lose market share as Morrisons' increases.

```{r show_share_by_week, echo = FALSE, message = FALSE, warning = FALSE, fig.height = 5, fig.width = 9, fig.cap = "Shop-level market share per week. Note the peaks in Morrisons' share just prior to weeks 20 and 40."}
share_by_week
```

In order to understand what might be driving changes in both sales and market share, the relationship between both average price and promotional level with market share was investigated (figures TODO and TODO).

```{r show_price_to_share, echo = FALSE, message = FALSE, warning = FALSE, fig.height = 5, fig.width = 10, fig.cap = "The relationship between average weekly price and weekly market share for each supermarket analysed. Coloured lines represent second order polynomial linear regressions of price on market share with the grey regions representing the 95% confidence interval for the fit."}
weekly_price_to_share
```


In terms of price, it appears that Morrisons benefits most (in terms of increased market share) from a price in the middle of the range of prices that it has set. This is in contrast with, for example, Asda where it is clear that a higher price results in a lower market share. It can also be seen that, in terms of average price, Morrisons actually has weeks with some of the highest average prices across the five shops studied, and in these weeks sees a sharp drop in its market share. At much lower prices, Morrisons market share also drops, although the reasons for this are unclear. 

```{r show_price_to_promo, echo = FALSE, message = FALSE, warning = FALSE, fig.height = 5, fig.width = 10, fig.cap = "The relationship between weekly proportion of sales on promotion and weekly market share for each supermarket analysed. Coloured lines represent second order polynomial linear regressions of proportion of promotional sales on market share with the grey regions representing the 95% confidence interval for the fit. The vertical dotted grey line is at 50% promotions, with points to to the right of that line indicating the majority of sales in that week were on promotion."}
weekly_share_to_prop_promo
```

Similarly looking at the relationship between the proportion of weekly sales that were made on promotion and weekly market share also reveals some interesting insights. For Morrisons, there is a very strong relationship between promotional levels and market share. In general, more promotions relates to an increased market share. Such a strong relationship is not observed for other supermarkets (especially for Asda and Sainsburys). Furthermore, it is interesting to note that Morrisons' two best weeks (in terms of market share) were the weeks with the two highest levels of promotion.

Broadly speaking, a shop can grow its customers in one of two ways: by stealing from other stores or by increasing the market size. In order to investigate which of these approaches might be relevant for Morrisons, the relationship between total market size (in terms of sales) and weekly market share was plotted for each supermarket (figure TODO). The numerical correlation between market share and total market size was also computed and is displayed in table TODO.

```{r total_sales_to_share, echo = FALSE, message = FALSE, warning = FALSE, fig.height = 5, fig.width = 10, fig.cap = "The relationship between total sales and market share for each shop. Colour lines indicate the linear relationship between, with grey regions showing the 95% confidence interval for this fit."}
share_to_total_sales_plot
```

```{r total_sales_to_share_table, echo = FALSE, message = FALSE, warning = FALSE}
share_to_total_sales_cor %>% 
  kable(col.names = c("Shop", "Correlation", "p-Value"),
        caption = "Correlation between total market size and market share for each supermarket, along with statistical significance (p-value) of that correlation.")
```

It can be seen that Morrisons actually has a positive and highly statistically significant relationship between total market size, and market share. I.e., when the size of the total market increases, it is Morrisons that is gaining the most customers/transactions from this and increasing its market share. This shows that Morrisons can (at least to some extent) grow its sales by increasing the size of the market.

If Morrisons also steals customers from other shops, it is important to know which ones. The correlations between weekly market shares for all five shops was assessed and is presented in figure TODO. 

```{r show_spm, echo = FALSE, warning = F, message = F, fig.height = 6, fig.width = 10, fig.cap = "Relationships in weekly market share between all five retailers (N.B. Discounters are Aldi and Lidl). The lower half of the plot shows the pair-wise combinations with individual linear relationships, the diagonal plots show the distribution of weekly market share for each shop, and the upper-right of the plot shows the correlation values between each combination of shop's market share. Significance codes for these values are indicated using asterisks (more means more significant)."}
share_pairs_all
```

From the data present in figure TODO it is clear that Morrisons can also increase its market share at the expense of Sainsburys and Tesco primarily, but also from Aldi and Lidl ("discounters"). Note that figure TODO shows an overall level view for all customer segments. The pair-wise patterns remain constant accross the three individual customer segments analyses. However the numerical values of the correlations change slightly, and as such the values for each consumer segment are presented in appendix TODO.

### Price Elasticitiy

### Shop Choice

### Shop Traffic

# Conclusion and Recommendations

# Appendices

## Appendix TODO - Market share correlations for light, medium, and heavy users

```{r share_correl_l, echo = FALSE}
weekly_share_cor_l %>% kable(caption = "Market share correlations for light users")
```

```{r share_correl_m, echo = FALSE}
weekly_share_cor_m %>% kable(caption = "Market share correlations for medium users")
```

```{r share_correl_h, echo = FALSE}
weekly_share_cor_h %>% kable(caption = "Market share correlations for medium users")
```

# References

1. Leach et al (2016), _Retail Analytics Group Report_, Imperial College Business School